name: ğŸš€ Production Deployment

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging

env:
  NODE_VERSION: '18'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Pre-deployment Quality Gate
  pre-deployment-quality:
    name: ğŸ›¡ï¸ Pre-Deployment Quality Gate
    uses: ./.github/workflows/quality-gate.yml
    secrets: inherit

  # Security & Compliance Check
  security-compliance:
    name: ğŸ”’ Security & Compliance
    runs-on: ubuntu-latest
    needs: pre-deployment-quality
    
    steps:
      - name: ğŸ“¦ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Install Dependencies
        run: npm ci

      - name: ğŸ” Vietnamese Market Compliance Check
        run: |
          echo "ğŸ‡»ğŸ‡³ Checking Vietnamese market compliance..."
          
          # Check for VNPay integration security
          if grep -r "vnp_" --include="*.ts" --include="*.js" lib/ components/ app/; then
            echo "âœ… VNPay integration found - validating security patterns"
            
            # Check for sensitive data handling
            if grep -r "vnp_.*password\|vnp_.*secret" --include="*.ts" --include="*.js" . || \
               grep -r "console\.log.*vnp_\|alert.*vnp_" --include="*.ts" --include="*.js" .; then
              echo "âŒ CRITICAL: VNPay sensitive data exposure detected!"
              exit 1
            fi
            echo "âœ… VNPay security patterns validated"
          fi
          
          # Check for MoMo integration security
          if grep -r "momo_" --include="*.ts" --include="*.js" lib/ components/ app/; then
            echo "âœ… MoMo integration found - validating security patterns"
            
            if grep -r "momo_.*secret\|momo_.*key" --include="*.ts" --include="*.js" . || \
               grep -r "console\.log.*momo_\|alert.*momo_" --include="*.ts" --include="*.js" .; then
              echo "âŒ CRITICAL: MoMo sensitive data exposure detected!"
              exit 1
            fi
            echo "âœ… MoMo security patterns validated"
          fi
          
          echo "âœ… Vietnamese payment gateway compliance validated"

      - name: ğŸ” Environment Variables Security Check
        run: |
          echo "ğŸ” Checking for exposed secrets in code..."
          
          # Check for hardcoded secrets
          if grep -r -E "(password|secret|key|token).*=.*['\"][^'\"]{10,}" --include="*.ts" --include="*.js" . --exclude-dir=node_modules --exclude-dir=.git; then
            echo "âŒ CRITICAL: Hardcoded secrets detected!"
            exit 1
          fi
          
          # Check for API keys in comments
          if grep -r -E "(api.key|secret.key|access.token)" --include="*.ts" --include="*.js" . --exclude-dir=node_modules --exclude-dir=.git; then
            echo "âš ï¸ WARNING: Potential API key references found in comments"
          fi
          
          echo "âœ… No exposed secrets detected"

      - name: ğŸ“‹ GDPR & Data Privacy Compliance
        run: |
          echo "ğŸ‡ªğŸ‡º Checking GDPR compliance for Vietnamese users..."
          
          # Check for data collection patterns
          if grep -r "localStorage\|sessionStorage\|cookie" --include="*.ts" --include="*.js" lib/ components/ app/; then
            echo "âœ… Data storage detected - ensuring privacy compliance"
            
            # Check for user consent mechanisms
            if ! grep -r "consent\|privacy\|gdpr" --include="*.ts" --include="*.js" .; then
              echo "âš ï¸ WARNING: Data storage found but no consent mechanism detected"
            fi
          fi
          
          echo "âœ… Privacy compliance check completed"

  # Build & Test Production Image
  build-production:
    name: ğŸ—ï¸ Build Production Image
    runs-on: ubuntu-latest
    needs: security-compliance
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}
    
    steps:
      - name: ğŸ“¦ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Install Dependencies
        run: npm ci

      - name: ğŸ—ï¸ Production Build
        run: npm run build
        env:
          CI: true
          NODE_ENV: production

      - name: ğŸ§ª Production Build Smoke Test
        run: |
          echo "ğŸ” Running production build smoke tests..."
          
          # Check critical files exist
          if [ ! -f ".next/BUILD_ID" ]; then
            echo "âŒ BUILD_ID missing - build incomplete"
            exit 1
          fi
          
          # Check bundle sizes
          MAIN_BUNDLE_SIZE=$(find .next/static/chunks -name "pages-*.js" -exec du -k {} \; | cut -f1 | head -1 || echo "0")
          if [ "$MAIN_BUNDLE_SIZE" -gt 1000 ]; then
            echo "âš ï¸ WARNING: Main bundle size ${MAIN_BUNDLE_SIZE}KB exceeds 1MB"
          fi
          
          echo "âœ… Production build validated"

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“ Extract Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-

      - name: ğŸ—ï¸ Build and Push Docker Image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Production Deployment
  deploy-production:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: build-production
    environment: 
      name: production
      url: https://prismy.app
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: ğŸ“¦ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸš€ Deploy to Production
        run: |
          echo "ğŸš€ Deploying Prismy to production..."
          echo "ğŸ“¦ Image: ${{ needs.build-production.outputs.image-tag }}"
          echo "ğŸ”’ Digest: ${{ needs.build-production.outputs.image-digest }}"
          
          # Here you would integrate with your deployment platform
          # Examples: Vercel, Railway, AWS, GCP, etc.
          
          echo "âœ… Production deployment initiated"

      - name: ğŸ¥ Health Check
        run: |
          echo "ğŸ¥ Running post-deployment health checks..."
          
          # Wait for deployment to be ready
          sleep 60
          
          # Health check endpoints
          HEALTH_ENDPOINTS=(
            "https://prismy.app/api/health"
            "https://prismy.app/api/auth/csrf"
            "https://prismy.app/api/translation/health"
          )
          
          for endpoint in "${HEALTH_ENDPOINTS[@]}"; do
            if curl -f -m 10 "$endpoint" > /dev/null 2>&1; then
              echo "âœ… $endpoint - OK"
            else
              echo "âŒ $endpoint - FAILED"
              exit 1
            fi
          done
          
          echo "âœ… All health checks passed"

      - name: ğŸ§ª Production Smoke Tests
        run: |
          echo "ğŸ§ª Running production smoke tests..."
          
          # Test critical user journeys
          curl -f "https://prismy.app" > /dev/null
          echo "âœ… Homepage accessible"
          
          # Test API endpoints
          curl -f "https://prismy.app/api/health" > /dev/null
          echo "âœ… API health check passed"
          
          # Test Vietnamese localization
          if curl -s "https://prismy.app" | grep -q "Tiáº¿ng Viá»‡t\|Vietnamese"; then
            echo "âœ… Vietnamese localization detected"
          else
            echo "âš ï¸ WARNING: Vietnamese localization not detected"
          fi
          
          echo "âœ… Production smoke tests completed"

  # Post-Deployment Monitoring
  post-deployment:
    name: ğŸ“Š Post-Deployment Monitoring
    runs-on: ubuntu-latest
    needs: deploy-production
    if: always() && needs.deploy-production.result == 'success'
    
    steps:
      - name: ğŸ“Š Deployment Summary
        run: |
          echo "## ğŸš€ Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ğŸ¯ Deployment Target**: Production" >> $GITHUB_STEP_SUMMARY
          echo "**ğŸ“¦ Image**: ${{ needs.build-production.outputs.image-tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**â° Deployed**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "**ğŸ”— URL**: https://prismy.app" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Quality Gates Passed" >> $GITHUB_STEP_SUMMARY
          echo "- **Coverage**: â‰¥70% lines, â‰¥60% branches" >> $GITHUB_STEP_SUMMARY
          echo "- **Security**: OWASP ZAP + CodeQL analysis" >> $GITHUB_STEP_SUMMARY
          echo "- **Compliance**: Vietnamese payment gateway security" >> $GITHUB_STEP_SUMMARY
          echo "- **Accessibility**: A11y validation completed" >> $GITHUB_STEP_SUMMARY
          echo "- **Build**: Production build verified" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ‡»ğŸ‡³ **Tuyá»‡t Ä‘á»‘i**: Sáº£n pháº©m Ä‘áº§u ra khÃ´ng thoáº£ hiá»‡p vá» cháº¥t lÆ°á»£ng!" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ”” Deployment Notification
        run: |
          echo "ğŸ”” Sending deployment notifications..."
          echo "âœ… Prismy production deployment completed successfully"
          echo "ğŸŒ Application URL: https://prismy.app"
          echo "ğŸ“ˆ Quality metrics maintained at target levels"
          echo "ğŸ‡»ğŸ‡³ Vietnamese market compliance validated"