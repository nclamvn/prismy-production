<!DOCTYPE html>
<html>
<head>
    <title>OAuth Debug Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .log { background: #f5f5f5; padding: 20px; border-radius: 8px; margin: 20px 0; }
        .error { background: #ffebee; border-left: 4px solid #f44336; }
        .success { background: #e8f5e9; border-left: 4px solid #4caf50; }
        button { padding: 12px 24px; font-size: 16px; margin: 10px; cursor: pointer; }
        .test-btn { background: #2196f3; color: white; border: none; border-radius: 4px; }
        .debug-btn { background: #ff9800; color: white; border: none; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>üîç OAuth Debug Test</h1>
    
    <button class="test-btn" onclick="testOAuthFlow()">üöÄ Test OAuth Flow</button>
    <button class="debug-btn" onclick="checkCookies()">üç™ Check Cookies</button>
    <button class="debug-btn" onclick="checkCallback()">üì° Test Callback</button>
    <button class="debug-btn" onclick="checkAuth()">üîê Check Auth Status</button>
    
    <div id="logs" class="log">
        <h3>Debug Logs:</h3>
        <div id="logContent">Ready for testing...</div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const supabaseUrl = 'https://ziyereoasqiqhjvedgit.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InppeWVyZW9hc3FpcWhqdmVkZ2l0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQ5NDA1MzgsImV4cCI6MjA1MDUxNjUzOH0.w-H8WJF4VEhXOlMOJHzKu0XPMGVFTI1YrADLQHGMhAE'
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey)
        
        function log(message, type = 'info') {
            const logContent = document.getElementById('logContent')
            const timestamp = new Date().toISOString().split('T')[1].split('.')[0]
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : ''
            logContent.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`
            logContent.scrollTop = logContent.scrollHeight
        }
        
        async function testOAuthFlow() {
            log('üöÄ Starting OAuth flow test...')
            
            try {
                const { data, error } = await supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: `${window.location.origin}/auth/callback?next=/app`,
                        queryParams: {
                            access_type: 'offline',
                            prompt: 'consent'
                        }
                    }
                })
                
                if (error) {
                    log(`‚ùå OAuth initiation failed: ${error.message}`, 'error')
                } else {
                    log(`‚úÖ OAuth initiated successfully`, 'success')
                    log(`Redirect URL: ${data.url || 'No URL returned'}`)
                }
                
            } catch (err) {
                log(`üí• Exception: ${err.message}`, 'error')
            }
        }
        
        async function checkCookies() {
            log('üç™ Checking cookies...')
            
            // Check document cookies
            const cookies = document.cookie.split(';').map(c => c.trim())
            log(`Total cookies: ${cookies.length}`)
            
            cookies.forEach(cookie => {
                const [name, value] = cookie.split('=')
                if (name.includes('sb-') || name.includes('supabase') || name.includes('auth')) {
                    log(`  ${name}: ${value?.substring(0, 30)}...`)
                }
            })
            
            // Call debug endpoint
            try {
                const response = await fetch('/api/debug-cookies')
                const debugData = await response.json()
                log(`üîç Server-side cookies: ${JSON.stringify(debugData, null, 2)}`)
            } catch (err) {
                log(`‚ùå Failed to fetch debug cookies: ${err.message}`, 'error')
            }
        }
        
        async function checkCallback() {
            log('üì° Testing callback endpoint...')
            
            try {
                const response = await fetch('/auth/callback?code=test&next=/app', {
                    method: 'GET',
                    redirect: 'manual'
                })
                
                log(`Callback response status: ${response.status}`)
                log(`Callback response type: ${response.type}`)
                
                if (response.status === 0 && response.type === 'opaqueredirect') {
                    log('‚úÖ Callback endpoint is accessible and redirecting', 'success')
                } else {
                    const text = await response.text()
                    log(`Callback response: ${text.substring(0, 200)}...`)
                }
                
            } catch (err) {
                log(`‚ùå Callback test failed: ${err.message}`, 'error')
            }
        }
        
        async function checkAuth() {
            log('üîê Checking current auth status...')
            
            try {
                const { data: { session }, error } = await supabase.auth.getSession()
                
                if (error) {
                    log(`‚ùå Auth check failed: ${error.message}`, 'error')
                } else if (session) {
                    log(`‚úÖ User is authenticated: ${session.user.email}`, 'success')
                    log(`User ID: ${session.user.id}`)
                    log(`Session expires: ${new Date(session.expires_at * 1000)}`)
                } else {
                    log('‚ÑπÔ∏è No active session found')
                }
                
            } catch (err) {
                log(`üí• Auth check exception: ${err.message}`, 'error')
            }
        }
        
        // Check URL for auth code on page load
        window.addEventListener('load', () => {
            const params = new URLSearchParams(window.location.search)
            const code = params.get('code')
            const error = params.get('error')
            
            if (code) {
                log(`‚úÖ OAuth code detected: ${code.substring(0, 20)}...`, 'success')
            } else if (error) {
                log(`‚ùå OAuth error detected: ${error}`, 'error')
            }
        })
    </script>
</body>
</html>